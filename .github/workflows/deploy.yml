name: CD Pipeline with Docker Compose

on:
  push:
    tags:
      - 'v*.*.*'
  release:
    types: [published]
  workflow_dispatch:

env:
  SSH_HOST: 'course.prafdin.ru'
  SSH_PORT: '2457'
  SSH_USERNAME: 'uwu'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push Backend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/website-backend:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/website-backend:${{ github.ref_name }}
    
    - name: Copy all files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.SSH_HOST }}
        port: ${{ env.SSH_PORT }}
        username: ${{ env.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "."
        target: "/home/${{ env.SSH_USERNAME }}/website-example"
        strip_components: 1
    
    - name: Deploy to VM with Docker Compose
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ env.SSH_HOST }}
        port: ${{ env.SSH_PORT }}
        username: ${{ env.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          echo "=== Starting Docker Compose deployment ==="
          
          cd /home/${{ env.SSH_USERNAME }}/website-example
          
          # Login to Docker Hub
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
          
          echo "=== Pulling latest Docker images ==="
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/website-backend:latest
          docker pull nginx:alpine
          
          echo "=== Stopping any existing containers ==="
          docker compose down || true
          
          # Принудительно освобождаем порт 8181 если он занят
          echo "=== Checking port 8181 ==="
          sudo ss -tulpn | grep 8181 && echo "Port 8181 is in use, killing process..." && sudo fuser -k 8181/tcp || echo "Port 8181 is free"
          
          echo "=== Deploying with Docker Compose ==="
          docker compose up -d
          
          echo "=== Waiting for containers to start ==="
          sleep 10
          
          echo "=== Diagnostic information ==="
          echo "1. Container status:"
          docker compose ps
          echo ""
          
          echo "2. Container logs:"
          docker compose logs --tail=10
          echo ""
          
          echo "3. Testing application..."
          echo "Testing static files:"
          curl -f http://localhost:8181/ && echo "✅ Static files working!" || echo "❌ Static files failed"
          echo ""
          
          echo "Testing API:"
          curl -f http://localhost:8181/api/posts && echo "✅ API working!" || echo "❌ API failed"
          echo ""
          
          echo "=== Cleaning up ==="
          docker image prune -f
          
          echo "=== Docker Compose deployment completed ==="
          echo "App should be available at: http://${{ env.SSH_HOST }}:8181/"